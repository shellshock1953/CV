name: Generate PDF

on:
  workflow_dispatch:  # Manual trigger
  workflow_call:      # Can be called by other workflows
    inputs:
      release_tag:
        description: 'Release tag to attach PDF to'
        required: true
        type: string

permissions:
  contents: write

jobs:
  generate-pdf:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main  # Always use latest main branch (where HTML was committed)

      - name: Pull latest changes
        run: |
          git pull origin main
          echo "Latest commit:"
          git log -1 --oneline

      - name: Verify index.html exists
        run: |
          if [ ! -f index.html ]; then
            echo "ERROR: index.html not found!"
            exit 1
          fi
          echo "index.html size: $(wc -c < index.html) bytes"
          echo "Last modified: $(stat -f "%Sm" -t "%Y-%m-%d %H:%M:%S" index.html || stat -c "%y" index.html)"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Playwright and dependencies
        run: |
          pip install playwright
          playwright install chromium --with-deps

      - name: Generate PDF from HTML
        run: |
          python -c "
          from playwright.sync_api import sync_playwright
          import os

          with sync_playwright() as p:
              browser = p.chromium.launch()
              page = browser.new_page()

              # Load the index.html file
              file_path = os.path.abspath('index.html')
              page.goto(f'file://{file_path}')

              # Wait for content to load
              page.wait_for_load_state('networkidle')

              # Generate PDF
              page.pdf(
                  path='cv_bohdan_sukhomlinov.pdf',
                  format='A4',
                  print_background=True,
                  margin={
                      'top': '0.5cm',
                      'right': '0.5cm',
                      'bottom': '0.5cm',
                      'left': '0.5cm'
                  }
              )

              browser.close()
              print('✅ PDF generated successfully')
          "

      - name: Upload PDF as artifact
        uses: actions/upload-artifact@v4
        with:
          name: cv-pdf
          path: cv_bohdan_sukhomlinov.pdf

      - name: Attach PDF to release
        if: inputs.release_tag != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload "${{ inputs.release_tag }}" cv_bohdan_sukhomlinov.pdf --clobber
          echo "✅ PDF attached to release ${{ inputs.release_tag }}"
